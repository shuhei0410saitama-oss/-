<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF 音読リーダー</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', 'Meiryo', sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.6;
      padding: 20px;
    }
    h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
    .subtitle { color: #6e6e73; font-size: 0.9rem; margin-bottom: 20px; }
    .card {
      background: #fff;
      border: 1px solid #d2d2d7;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .card h2 { font-size: 1rem; font-weight: 600; margin-bottom: 12px; }

    /* Drop zone */
    .drop-zone {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 120px;
      border: 2px dashed #d2d2d7;
      border-radius: 12px;
      background: #fafafa;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
      margin-bottom: 16px;
      text-align: center;
      padding: 16px;
    }
    .drop-zone:hover, .drop-zone.dragover {
      background: #e8f0fe;
      border-color: #0071e3;
    }
    .drop-zone p { font-size: 0.95rem; color: #6e6e73; }
    .drop-zone .filename { font-weight: 600; color: #1d1d1f; }
    .drop-zone .page-count { font-size: 0.85rem; color: #86868b; margin-top: 4px; }

    /* Form controls */
    .row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 10px; }
    label.inline { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; cursor: pointer; }
    input[type="number"] {
      width: 70px; border: 1px solid #d2d2d7; border-radius: 8px;
      padding: 4px 8px; font-size: 0.9rem; text-align: center;
    }
    input[type="range"] { flex: 1; min-width: 100px; }
    select {
      flex: 1; border: 1px solid #d2d2d7; border-radius: 8px;
      padding: 4px 8px; font-size: 0.9rem; min-width: 0;
    }
    .range-label { font-size: 0.85rem; color: #6e6e73; min-width: 50px; }
    .range-value { font-size: 0.85rem; font-weight: 600; min-width: 40px; text-align: right; }
    .sep { color: #86868b; }

    /* Buttons */
    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 16px; }
    button {
      border: none; border-radius: 10px; padding: 10px 24px;
      font-size: 0.9rem; font-weight: 600; cursor: pointer;
      transition: opacity 0.2s;
    }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-play { background: #0071e3; color: #fff; }
    .btn-pause { background: #f0ad4e; color: #fff; }
    .btn-resume { background: #34c759; color: #fff; }
    .btn-stop { background: #ff3b30; color: #fff; }
    .status { font-size: 0.85rem; color: #6e6e73; }

    /* Text areas */
    .text-box {
      max-height: 300px;
      overflow-y: auto;
      background: #f9f9f9;
      border: 1px solid #e5e5ea;
      border-radius: 8px;
      padding: 12px;
      font-size: 0.85rem;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.8;
    }
    .page-block {
      border: 1px solid #e5e5ea;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .page-block.active { border-color: #0071e3; background: #e8f0fe; }
    .page-label { font-size: 0.75rem; font-weight: 600; color: #86868b; margin-bottom: 4px; }

    .hidden { display: none; }
    .loading { text-align: center; padding: 40px; color: #6e6e73; }
    .error { background: #fff0f0; border: 1px solid #ffc0c0; color: #c00; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.9rem; }
  </style>
</head>
<body>

<h1>PDF 音読リーダー</h1>
<p class="subtitle">PDFをアップロードして、指定範囲を音読します。括弧やスペースも読み上げます。</p>

<!-- File Upload -->
<div class="drop-zone" id="dropZone">
  <div>
    <p id="dropLabel">PDFファイルをドラッグ＆ドロップ、またはクリックして選択</p>
  </div>
</div>
<input type="file" id="fileInput" accept=".pdf" style="display:none" />

<div id="errorBox" class="error hidden"></div>
<div id="loadingBox" class="loading hidden">PDFを読み込み中...</div>

<!-- Settings (hidden until PDF loaded) -->
<div id="settingsArea" class="hidden">

  <!-- Page Range -->
  <div class="card">
    <h2>読み上げ範囲</h2>
    <div class="row">
      <label class="inline">開始: <input type="number" id="startPage" min="1" value="1" /></label>
      <span class="sep">〜</span>
      <label class="inline">終了: <input type="number" id="endPage" min="1" value="1" /></label>
      <span class="range-label" id="totalLabel">/ 全 1 ページ</span>
    </div>
  </div>

  <!-- TTS Settings -->
  <div class="card">
    <h2>読み上げ設定</h2>
    <div class="row">
      <label class="inline"><input type="checkbox" id="chkPunctuation" checked /> 括弧・記号を読み上げる</label>
      <label class="inline"><input type="checkbox" id="chkSpaces" checked /> スペースを読み上げる</label>
    </div>
    <div class="row">
      <span class="range-label">速度:</span>
      <input type="range" id="rateSlider" min="0.5" max="2.0" step="0.1" value="1.0" />
      <span class="range-value" id="rateValue">1.0x</span>
    </div>
    <div class="row">
      <span class="range-label">高さ:</span>
      <input type="range" id="pitchSlider" min="0.5" max="2.0" step="0.1" value="1.0" />
      <span class="range-value" id="pitchValue">1.0</span>
    </div>
    <div class="row">
      <span class="range-label">音声:</span>
      <select id="voiceSelect"><option value="">読み込み中...</option></select>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button class="btn-play" id="btnPlay">再生</button>
    <button class="btn-pause hidden" id="btnPause">一時停止</button>
    <button class="btn-resume hidden" id="btnResume">再開</button>
    <button class="btn-stop hidden" id="btnStop">停止</button>
    <span class="status" id="statusText"></span>
  </div>

  <!-- Preview -->
  <div class="card">
    <h2>読み上げプレビュー（変換後テキスト）</h2>
    <div class="text-box" id="previewBox">（テキストなし）</div>
  </div>

  <!-- Original Text -->
  <div class="card">
    <h2>抽出テキスト（元のテキスト）</h2>
    <div class="text-box" id="originalBox"></div>
  </div>
</div>

<script>
// ── PDF.js setup ──
var pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ── Punctuation map ──
var PUNCTUATION_MAP = {
  '\u300C': ' \u304B\u304E\u304B\u3063\u3053 ',
  '\u300D': ' \u304B\u304E\u304B\u3063\u3053\u9589\u3058 ',
  '\u300E': ' \u4E8C\u91CD\u304B\u304E\u304B\u3063\u3053 ',
  '\u300F': ' \u4E8C\u91CD\u304B\u304E\u304B\u3063\u3053\u9589\u3058 ',
  '\uFF08': ' \u304B\u3063\u3053 ',
  '\uFF09': ' \u304B\u3063\u3053\u9589\u3058 ',
  '(': ' \u304B\u3063\u3053 ',
  ')': ' \u304B\u3063\u3053\u9589\u3058 ',
  '\u3010': ' \u3059\u307F\u3064\u304D\u304B\u3063\u3053 ',
  '\u3011': ' \u3059\u307F\u3064\u304D\u304B\u3063\u3053\u9589\u3058 ',
  '\u3008': ' \u3084\u307E\u304B\u3063\u3053 ',
  '\u3009': ' \u3084\u307E\u304B\u3063\u3053\u9589\u3058 ',
  '\u300A': ' \u4E8C\u91CD\u3084\u307E\u304B\u3063\u3053 ',
  '\u300B': ' \u4E8C\u91CD\u3084\u307E\u304B\u3063\u3053\u9589\u3058 ',
  '\u201C': ' \u5F15\u7528\u7B26 ',
  '\u201D': ' \u5F15\u7528\u7B26\u9589\u3058 ',
  '\u30FB': ' \u306A\u304B\u3050\u308D ',
  '\u2026': ' \u3066\u3093\u3066\u3093\u3066\u3093 ',
  '\u2015': ' \u30C0\u30C3\u30B7\u30E5 ',
  '\u2013': ' \u30C0\u30C3\u30B7\u30E5 ',
  '\u2014': ' \u30C0\u30C3\u30B7\u30E5 ',
  '\u301C': ' \u304B\u3089 ',
  '~': ' \u304B\u3089 ',
  '\u203B': ' \u3053\u3081\u3058\u308B\u3057 ',
  '\u2192': ' \u3084\u3058\u308B\u3057 ',
  '\u2190': ' \u3072\u3060\u308A\u3084\u3058\u308B\u3057 ',
  '\u2191': ' \u3046\u3048\u3084\u3058\u308B\u3057 ',
  '\u2193': ' \u3057\u305F\u3084\u3058\u308B\u3057 '
};

// More readable aliases for display
var PUNCTUATION_MAP_DISPLAY = {};
</script>
<script>
// Use readable strings instead of unicode escapes
(function() {
  var map = {
    '\u300C': ' かぎかっこ ',
    '\u300D': ' かぎかっこ閉じ ',
    '\u300E': ' 二重かぎかっこ ',
    '\u300F': ' 二重かぎかっこ閉じ ',
    '\uFF08': ' かっこ ',
    '\uFF09': ' かっこ閉じ ',
    '(': ' かっこ ',
    ')': ' かっこ閉じ ',
    '\u3010': ' すみつきかっこ ',
    '\u3011': ' すみつきかっこ閉じ ',
    '\u3008': ' やまかっこ ',
    '\u3009': ' やまかっこ閉じ ',
    '\u300A': ' 二重やまかっこ ',
    '\u300B': ' 二重やまかっこ閉じ ',
    '\u201C': ' 引用符 ',
    '\u201D': ' 引用符閉じ ',
    '\u30FB': ' なかぐろ ',
    '\u2026': ' てんてんてん ',
    '\u2015': ' ダッシュ ',
    '\u2013': ' ダッシュ ',
    '\u2014': ' ダッシュ ',
    '\u301C': ' から ',
    '~': ' から ',
    '\u203B': ' こめじるし ',
    '\u2192': ' やじるし ',
    '\u2190': ' ひだりやじるし ',
    '\u2191': ' うえやじるし ',
    '\u2193': ' したやじるし '
  };
  PUNCTUATION_MAP = map;
})();

function convertPunctuation(text, readPunct, readSpaces) {
  var r = text;
  if (readPunct) {
    var keys = Object.keys(PUNCTUATION_MAP);
    for (var i = 0; i < keys.length; i++) {
      r = r.split(keys[i]).join(PUNCTUATION_MAP[keys[i]]);
    }
  }
  if (readSpaces) {
    r = r.replace(/ {2,}/g, function(m) { return ' ' + m.length + 'つスペース '; });
    r = r.replace(/\u3000/g, ' 全角スペース ');
  }
  return r;
}

function splitChunks(text, max) {
  max = max || 200;
  var chunks = [];
  var rem = text;
  while (rem.length > 0) {
    if (rem.length <= max) { chunks.push(rem); break; }
    var bp = -1;
    for (var i = max; i >= max / 2; i--) {
      if ('。、！？\n'.indexOf(rem[i]) !== -1) { bp = i + 1; break; }
    }
    if (bp === -1) bp = max;
    chunks.push(rem.slice(0, bp));
    rem = rem.slice(bp);
  }
  return chunks;
}

// ── State ──
var pages = [];
var synth = window.speechSynthesis;

// ── DOM refs ──
function $(id) { return document.getElementById(id); }
var dropZone = $('dropZone');
var fileInput = $('fileInput');
var dropLabel = $('dropLabel');
var errorBox = $('errorBox');
var loadingBox = $('loadingBox');
var settingsArea = $('settingsArea');
var startPageEl = $('startPage');
var endPageEl = $('endPage');
var totalLabel = $('totalLabel');
var chkPunctuation = $('chkPunctuation');
var chkSpaces = $('chkSpaces');
var rateSlider = $('rateSlider');
var rateValueEl = $('rateValue');
var pitchSlider = $('pitchSlider');
var pitchValueEl = $('pitchValue');
var voiceSelect = $('voiceSelect');
var btnPlay = $('btnPlay');
var btnPause = $('btnPause');
var btnResume = $('btnResume');
var btnStop = $('btnStop');
var statusText = $('statusText');
var previewBox = $('previewBox');
var originalBox = $('originalBox');

// ── Voice loading ──
function loadVoices() {
  var all = synth.getVoices();
  var ja = all.filter(function(v) { return v.lang.indexOf('ja') === 0; });
  var list = ja.length > 0 ? ja : all;
  voiceSelect.innerHTML = '';
  for (var i = 0; i < list.length; i++) {
    var opt = document.createElement('option');
    opt.value = list[i].name;
    opt.textContent = list[i].name + ' (' + list[i].lang + ')';
    voiceSelect.appendChild(opt);
  }
}
loadVoices();
if (speechSynthesis.addEventListener) {
  speechSynthesis.addEventListener('voiceschanged', loadVoices);
}

// ── Slider display ──
rateSlider.addEventListener('input', function() {
  rateValueEl.textContent = parseFloat(rateSlider.value).toFixed(1) + 'x';
  updatePreview();
});
pitchSlider.addEventListener('input', function() {
  pitchValueEl.textContent = parseFloat(pitchSlider.value).toFixed(1);
});
chkPunctuation.addEventListener('change', updatePreview);
chkSpaces.addEventListener('change', updatePreview);
startPageEl.addEventListener('change', updatePreview);
endPageEl.addEventListener('change', updatePreview);

// ── File handling ──
dropZone.addEventListener('click', function() { fileInput.click(); });
dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
dropZone.addEventListener('drop', function(e) {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  var file = e.dataTransfer.files[0];
  if (file) loadPdfFile(file);
});
fileInput.addEventListener('change', function() { if (fileInput.files[0]) loadPdfFile(fileInput.files[0]); });

function loadPdfFile(file) {
  if (!file.name.toLowerCase().endsWith('.pdf')) {
    showError('PDFファイルを選択してください。');
    return;
  }
  hideError();
  loadingBox.classList.remove('hidden');
  settingsArea.classList.add('hidden');
  synth.cancel();
  updateButtons(false, false);

  var reader = new FileReader();
  reader.onload = function() {
    var typedArray = new Uint8Array(reader.result);
    pdfjsLib.getDocument({ data: typedArray }).promise.then(function(pdf) {
      var n = pdf.numPages;
      pages = [];
      var loaded = 0;

      function onPageDone() {
        loaded++;
        if (loaded === n) {
          pages.sort(function(a, b) { return a.pageNum - b.pageNum; });
          dropLabel.innerHTML = '<span class="filename">' + escHtml(file.name) + '</span><br><span class="page-count">' + n + ' ページ</span>';
          startPageEl.value = 1;
          startPageEl.max = n;
          endPageEl.value = n;
          endPageEl.max = n;
          totalLabel.textContent = '/ 全 ' + n + ' ページ';
          loadingBox.classList.add('hidden');
          settingsArea.classList.remove('hidden');
          updatePreview();
        }
      }

      for (var i = 1; i <= n; i++) {
        (function(pageNum) {
          pdf.getPage(pageNum).then(function(page) {
            page.getTextContent().then(function(content) {
              var text = content.items.map(function(item) {
                return item.str || '';
              }).join('');
              pages.push({ pageNum: pageNum, text: text });
              onPageDone();
            });
          });
        })(i);
      }
    }).catch(function() {
      loadingBox.classList.add('hidden');
      showError('PDFの読み込みに失敗しました。ファイルが壊れているか、対応していない形式の可能性があります。');
    });
  };
  reader.readAsArrayBuffer(file);
}

function updatePreview() {
  var s = parseInt(startPageEl.value, 10);
  var e = parseInt(endPageEl.value, 10);
  var sel = pages.filter(function(p) { return p.pageNum >= s && p.pageNum <= e; });
  var raw = sel.map(function(p) { return p.text; }).join('\n');
  var converted = convertPunctuation(raw, chkPunctuation.checked, chkSpaces.checked);
  previewBox.textContent = converted || '（テキストなし）';

  originalBox.innerHTML = '';
  for (var i = 0; i < sel.length; i++) {
    var div = document.createElement('div');
    div.className = 'page-block';
    div.id = 'page-' + sel[i].pageNum;
    var label = document.createElement('div');
    label.className = 'page-label';
    label.textContent = 'ページ ' + sel[i].pageNum;
    var body = document.createElement('div');
    body.textContent = sel[i].text || '（テキストなし）';
    div.appendChild(label);
    div.appendChild(body);
    originalBox.appendChild(div);
  }
}

// ── TTS Controls ──
btnPlay.addEventListener('click', startSpeaking);
btnPause.addEventListener('click', function() { synth.pause(); updateButtons(true, true); });
btnResume.addEventListener('click', function() { synth.resume(); updateButtons(true, false); });
btnStop.addEventListener('click', function() { synth.cancel(); updateButtons(false, false); statusText.textContent = ''; highlightPage(null); });

function startSpeaking() {
  synth.cancel();
  var s = parseInt(startPageEl.value, 10);
  var e = parseInt(endPageEl.value, 10);
  var sel = pages.filter(function(p) { return p.pageNum >= s && p.pageNum <= e; });
  if (sel.length === 0) return;

  updateButtons(true, false);

  function speakPage(idx) {
    if (idx >= sel.length) {
      updateButtons(false, false);
      statusText.textContent = '完了';
      highlightPage(null);
      return;
    }
    var pg = sel[idx];
    highlightPage(pg.pageNum);
    statusText.textContent = '読み上げ中: ' + pg.pageNum + ' ページ目';
    var text = convertPunctuation(pg.text, chkPunctuation.checked, chkSpaces.checked);
    if (!text.trim()) { speakPage(idx + 1); return; }

    var chunks = splitChunks(text, 200);
    var ci = 0;

    function next() {
      if (ci >= chunks.length) { speakPage(idx + 1); return; }
      var utt = new SpeechSynthesisUtterance(chunks[ci]);
      utt.rate = parseFloat(rateSlider.value);
      utt.pitch = parseFloat(pitchSlider.value);
      utt.lang = 'ja-JP';
      var vName = voiceSelect.value;
      if (vName) {
        var voices = synth.getVoices();
        for (var v = 0; v < voices.length; v++) {
          if (voices[v].name === vName) { utt.voice = voices[v]; break; }
        }
      }
      utt.onend = function() { ci++; next(); };
      utt.onerror = function(ev) { if (ev.error !== 'canceled') { ci++; next(); } };
      synth.speak(utt);
    }
    next();
  }
  speakPage(0);
}

function updateButtons(isSpeaking, isPaused) {
  btnPlay.classList.toggle('hidden', isSpeaking);
  btnPause.classList.toggle('hidden', !isSpeaking || isPaused);
  btnResume.classList.toggle('hidden', !isPaused);
  btnStop.classList.toggle('hidden', !isSpeaking);
}

function highlightPage(num) {
  var blocks = originalBox.querySelectorAll('.page-block');
  for (var i = 0; i < blocks.length; i++) blocks[i].classList.remove('active');
  if (num != null) {
    var el = document.getElementById('page-' + num);
    if (el) { el.classList.add('active'); el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
  }
}

// ── Helpers ──
function showError(msg) { errorBox.textContent = msg; errorBox.classList.remove('hidden'); }
function hideError() { errorBox.classList.add('hidden'); }
function escHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
</script>
</body>
</html>
